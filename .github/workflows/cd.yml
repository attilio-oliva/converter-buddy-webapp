name: Deploy to GitHub Pages

on:
  push:
    branches:
    - main
  pull_request:
    types:
    - opened
    - edited
    - synchronize
    - reopened
    branches:
    - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true
        target: wasm32-unknown-unknown
    - uses: Swatinem/rust-cache@v1
    - name: Install CLI
      run: cargo install dioxus-cli --locked
    - uses: actions/checkout@v2
    - name: Build
      run: dx build --release
    # Put the build in a branch for testing on pull requests
    - if: github.event_name == 'pull_request'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages-pr-test
        publish_dir: ./docs
    # Put the build gh pages public branch on main push/pr merge
    - if: github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
